{% extends "base.html" %}
{% block title %}–†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞{% endblock %}
{% block content %}
{% load i18n %}
<div class="mt-4">
    <h3 class="text-center">
        {% trans '–ö—ã—Ä–≥—ã–∑ –†–µ—Å–ø—É–±–ª–∏–∫–∞—Å—ã–Ω—ã–Ω –≠—Å–µ–ø—Ç”©”© –ø–∞–ª–∞—Ç–∞—Å—ã–Ω—ã–Ω –ë–æ—Ä–±–æ—Ä–¥—É–∫ –∞–ø–ø–∞—Ä–∞—Ç—ã–Ω—ã–Ω –∫—ã–∑–º–∞—Ç–∫–µ—Ä–ª–µ—Ä–∏–Ω–∏–Ω –∂–∞–π–≥–∞—à—Ç—ã—Ä—É—É—Å—É' %}
        <br>{{ selected_date|date:'d.m.Y' }}
    </h3>
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
            <a href="?date={{ previous_date|date:'Y-m-d' }}" class="btn btn-outline-primary btn-sm">‚Üê</a>
            <input type="date" id="calendar" value="{{ selected_date|date:'Y-m-d' }}"
                   class="form-control form-control-sm"
                   onchange="location.href='?date='+this.value">
            <a href="?date={{ next_date|date:'Y-m-d' }}" class="btn btn-outline-primary btn-sm">‚Üí</a>
        </div>

        <div class="d-flex align-items-center gap-2">
            {% if is_empty %}
            <form method="POST" action="{% url 'generate_arrangement_day' %}">
                {% csrf_token %}
                <input type="hidden" name="date" value="{{ selected_date|date:'Y-m-d' }}">
                <button type="submit" class="btn btn-success btn-sm">
                    <i class="fa-solid fa-calendar-plus me-2"></i>{% trans '–ü–ª–∞–Ω —Ç“Ø–∑“Ø“Ø' %}
                </button>
            </form>
            {% else %}
            <form method="post" action="{% url 'import_arrangement_day' %}" class="d-flex align-items-center gap-2">
                {% csrf_token %}
                <input type="hidden" name="target_date" value="{{ selected_date|date:'Y-m-d' }}">
                <input type="date" name="source_date" class="form-control form-control-sm" required>
                <button type="submit" class="btn btn-secondary btn-sm">{% trans '–ò–º–ø–æ—Ä—Ç—Ç–æ–æ' %}</button>
            </form>

            <form method="post" action="{% url 'clear_arrangement_day' %}">
                {% csrf_token %}
                <input type="hidden" name="date" value="{{ selected_date|date:'Y-m-d' }}">
                <button type="submit" class="btn btn-warning btn-sm">{% trans '–¢–∞–∑–∞–ª–æ–æ' %}</button>
            </form>
            {% endif %}
        </div>
    </div>

    {% if is_empty %}
    <!-- –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ -->
    <div class="alert alert-warning text-center mt-4">
        <strong>{% trans '–ë—É–ª –∫“Ø–Ω–≥”© –∂–∞–π–≥–∞—à—Ç—ã—Ä—É—É –ø–ª–∞–Ω—ã —Ç“Ø–∑“Ø–ª–≥”©–Ω —ç–º–µ—Å.' %}</strong><br>
        {% trans '–ü–ª–∞–Ω —Ç“Ø–∑“Ø“Ø –±–∞—Å–∫—ã—á—ã–Ω –±–∞—Å—ã–ø, –∫—ã–∑–º–∞—Ç–∫–µ—Ä–ª–µ—Ä–¥–∏ –∫–æ—à—É“£—É–∑.' %}
    </div>

    {% else %}
    <ul class="nav nav-tabs" id="arrangementTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="apparatus-tab"
                    data-bs-toggle="tab" data-bs-target="#apparatus"
                    type="button" role="tab">{% trans '–ê–ø–ø–∞—Ä–∞—Ç' %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inspectors-tab"
                    data-bs-toggle="tab" data-bs-target="#inspectors" type="button"
                    role="tab">{% trans '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä.—Ç–æ–ø' %}
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="arrangementTabsContent">
        <!-- üè¢ –ê–ø–ø–∞—Ä–∞—Ç -->
        <div class="tab-pane fade show active" id="apparatus" role="tabpanel">
            {% if apparatus %}
            <div class="table-responsive">
                <table class="table table-striped-columns text-center align-middle">
                    <thead class="table-primary">
                    {% blocktrans %}
                    <tr style="font-size: 12px">
                        <th>–ö—ã–∑–º–∞—Ç–∫–µ—Ä–¥–∏–Ω —Ñ–∞–º–∏–ª–∏—è—Å—ã, –∞—Ç—ã, –∞—Ç–∞—Å—ã–Ω—ã–Ω –∞—Ç—ã</th>
                        <th>–≠—ç–ª–µ–≥–µ–Ω –∫—ã–∑–º–∞—Ç –æ—Ä–¥—É</th>
                        <th>–ê—É–¥–∏—Ç –∂“Ø—Ä–≥“Ø–∑“Ø“Ø / –í–ê–ö –∏—à–∏–Ω–µ –∫–∞—Ç—ã—à—É—É / –æ–∫—É—Ç—É—É</th>
                        <th>–ê—É–¥–∏—Ç—Ç–∏–Ω/–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞–Ω—ã–Ω –º–∞–∫—Å–∞—Ç—ã</th>
                        <th>–ê—É–¥–∏—Ç—Ç–∏–Ω –Ω–µ–≥–∏–∑–∏/–∂–∞–Ω–∞ –±–∞—à–∫–∞ –∏—à —á–∞—Ä–∞–ª–∞—Ä (–∏—à –ø–ª–∞–Ω—ã, ‚Ññ —Ç”©—Ä–∞–≥–∞–Ω—ã–Ω
                            –±—É–π—Ä—É–≥—É–Ω—É–Ω –¥–∞—Ç–∞—Å—ã); –£–∑–∞—Ä—Ç—É—É —Ç—É—É—Ä–∞–ª—É—É –±—É–π—Ä—É–≥—É
                        </th>
                        <th>–ê—É–¥–∏—Ç—Ç–∏ –∂“Ø—Ä–≥“Ø–∑“Ø“Ø/ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞–Ω—ã–Ω –º”©”©–Ω”©—Ç“Ø</th>
                        <th>–î–∞—Ä–µ–≥–∏ (–æ–±–ª–∞—Å—Ç—å/—à–∞–∞—Ä/—Ä–∞–π–æ–Ω/–∞–π—ã–ª, –∫”©—á”©, —Ç–µ–ª ‚Ññ –∂.–±.)</th>
                        <th>–≠–º–≥–µ–∫ ”©—Ä–≥“Ø“Ø–¥”©, ”©—Ä–≥“Ø–º”©”©–¥”©, —ç–º–≥–µ–∫–∫–µ –∂–∞—Ä–∞–º—Å—ã–∑–¥—ã–∫ –±–∞—Ä–∞–∫—á–∞—Å—ã–Ω–¥–∞</th>
                        <th>–≠—Å–∫–µ—Ä—Ç“Ø“Ø (–°–∞–∞—Ç 9:15 –∫—ã–∑–º–∞—Ç-–¥–∏–Ω –∂—É–º—É—à –æ—Ä–¥—É–Ω–¥–∞—Ä—ã–Ω–¥–∞ –±–æ–ª—É—à—É–Ω —Ç–µ–∫—à–µ—Ä“Ø“Ø )</th>
                        <th>–ê—É–¥–∏—Ç, —ç–º–≥–µ–∫ ”©—Ä–≥“Ø“Ø –∂.–±. —É–±–∞–∫—ã—Ç—ã –±–∞—à—Ç–∞–ª–∞ —ç–ª–µ–∫</th>
                    </tr>
                    {% endblocktrans %}
                    </thead>
                    <tbody>
                    {% for arr in apparatus %}
                    <tr style="font-size: 12px">
                        <td style="font-size: 14px">{{ arr.profile.full_name }}</td>
                        <td>{{ arr.position.title }}</td>

                        <td class="editable" data-field="audit_conducting" data-id="{{ arr.id }}">
                            {{ arr.audit_conducting|default:" " }}
                        </td>
                        <td class="editable" data-field="audit_purpose" data-id="{{ arr.id }}">
                            {{ arr.audit_purpose|default:" " }}
                        </td>
                        <td class="editable" data-field="order_num_date" data-id="{{ arr.id }}">
                            {{ arr.order_num_date|default:" " }}
                        </td>
                        <td class="editable" data-field="order_dates" data-id="{{ arr.id }}">
                            {{ arr.order_dates|default:" " }}
                        </td>
                        <td class="editable" data-field="audit_address" data-id="{{ arr.id }}">
                            {{ arr.audit_address|default:" " }}
                        </td>
                        <td class="editable" data-field="on_status" data-id="{{ arr.id }}">
                            {{ arr.on_status|default:" " }}
                        </td>
                        <td class="editable" data-field="time_check" data-id="{{ arr.id }}">
                            {{ arr.time_check|default:" " }}
                        </td>
                        <td class="editable" data-field="time_not_start" data-id="{{ arr.id }}">
                            {{ arr.time_not_start|default:" " }}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">{% trans '–ö—ã–∑–º–µ—Ç–∫–µ—Ä–ª–µ—Ä–¥–∏–Ω –∂–∞–π–≥–∞—à—Ç—ã—Ä—É—É—Å—É –±“Ø–≥“Ø–Ω –∂–æ–∫' %}</p>
            {% endif %}
        </div>

        <!-- üïµÔ∏è –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞ -->
        <div class="tab-pane fade" id="inspectors" role="tabpanel">
            {% if inspectors %}
            <div class="table-responsive">
                <table class="table table-striped-columns text-center align-middle">
                    <thead class="table-primary">
                    {% blocktrans %}
                    <tr style="font-size: 12px">
                        <th>–ö—ã–∑–º–∞—Ç–∫–µ—Ä–¥–∏–Ω —Ñ–∞–º–∏–ª–∏—è—Å—ã, –∞—Ç—ã, –∞—Ç–∞—Å—ã–Ω—ã–Ω –∞—Ç—ã</th>
                        <th>–≠—ç–ª–µ–≥–µ–Ω –∫—ã–∑–º–∞—Ç –æ—Ä–¥—É</th>
                        <th>–ê—É–¥–∏—Ç –∂“Ø—Ä–≥“Ø–∑“Ø“Ø / –í–ê–ö –∏—à–∏–Ω–µ –∫–∞—Ç—ã—à—É—É / –æ–∫—É—Ç—É—É</th>
                        <th>–ê—É–¥–∏—Ç—Ç–∏–Ω/–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞–Ω—ã–Ω –º–∞–∫—Å–∞—Ç—ã</th>
                        <th>–ñ–æ–æ–ø—Ç—É—É –∞—É–¥–∏—Ç–æ—Ä</th>
                        <th>–ê—É–¥–∏—Ç—Ç–∏–Ω –Ω–µ–≥–∏–∑–∏/–∂–∞–Ω–∞ –±–∞—à–∫–∞ –∏—à —á–∞—Ä–∞–ª–∞—Ä (–∏—à –ø–ª–∞–Ω—ã, ‚Ññ —Ç”©—Ä–∞–≥–∞–Ω—ã–Ω
                            –±—É–π—Ä—É–≥—É–Ω—É–Ω –¥–∞—Ç–∞—Å—ã); –£–∑–∞—Ä—Ç—É—É —Ç—É—É—Ä–∞–ª—É—É –±—É–π—Ä—É–≥—É
                        </th>
                        <th>–ê—É–¥–∏—Ç—Ç–∏ –∂“Ø—Ä–≥“Ø–∑“Ø“Ø/ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞–Ω—ã–Ω –º”©”©–Ω”©—Ç“Ø</th>
                        <th>–î–∞—Ä–µ–≥–∏ (–æ–±–ª–∞—Å—Ç—å/—à–∞–∞—Ä/—Ä–∞–π–æ–Ω/–∞–π—ã–ª, –∫”©—á”©, —Ç–µ–ª ‚Ññ –∂.–±.)</th>
                        <th>–≠–º–≥–µ–∫ ”©—Ä–≥“Ø“Ø–¥”©, ”©—Ä–≥“Ø–º”©”©–¥”©, —ç–º–≥–µ–∫–∫–µ –∂–∞—Ä–∞–º—Å—ã–∑–¥—ã–∫ –±–∞—Ä–∞–∫—á–∞—Å—ã–Ω–¥–∞</th>
                        <th>–≠—Å–∫–µ—Ä—Ç“Ø“Ø (–°–∞–∞—Ç 9:15 –∫—ã–∑–º–∞—Ç-–¥–∏–Ω –∂—É–º—É—à –æ—Ä–¥—É–Ω–¥–∞—Ä—ã–Ω–¥–∞ –±–æ–ª—É—à—É–Ω —Ç–µ–∫—à–µ—Ä“Ø“Ø )</th>
                        <th>–ê—É–¥–∏—Ç, —ç–º–≥–µ–∫ ”©—Ä–≥“Ø“Ø –∂.–±. —É–±–∞–∫—ã—Ç—ã –±–∞—à—Ç–∞–ª–∞ —ç–ª–µ–∫</th>
                    </tr>
                    {% endblocktrans %}
                    </thead>
                    <tbody>
                    {% for arr in inspectors %}
                    <tr style="font-size: 12px">
                        <td style="font-size: 14px">{{ arr.profile.full_name }}</td>
                        <td>{{ arr.position.title }}</td>

                        <td class="editable" data-field="audit_conducting" data-id="{{ arr.id }}">
                            {{ arr.audit_conducting|default:" " }}
                        </td>
                        <td class="editable" data-field="audit_purpose" data-id="{{ arr.id }}">
                            {{ arr.audit_purpose|default:" " }}
                        </td>
                        <td class="editable" data-field="response_audit" data-id="{{ arr.id }}">
                            {{ arr.response_audit|default:" " }}
                        </td>
                        <td class="editable" data-field="order_num_date" data-id="{{ arr.id }}">
                            {{ arr.order_num_date|default:" " }}
                        </td>
                        <td class="editable" data-field="order_dates" data-id="{{ arr.id }}">
                            {{ arr.order_dates|default:" " }}
                        </td>
                        <td class="editable" data-field="audit_address" data-id="{{ arr.id }}">
                            {{ arr.audit_address|default:" " }}
                        </td>
                        <td class="editable" data-field="on_status" data-id="{{ arr.id }}">
                            {{ arr.on_status|default:" " }}
                        </td>
                        <td class="editable" data-field="time_check" data-id="{{ arr.id }}">
                            {{ arr.time_check|default:" " }}
                        </td>
                        <td class="editable" data-field="time_not_start" data-id="{{ arr.id }}">
                            {{ arr.time_not_start|default:" " }}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">{% trans '–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä–ª–æ—Ä–¥—É–Ω –∂–∞–π–≥–∞—à—Ç—ã—Ä—É—É—Å—É –±“Ø–≥“Ø–Ω –∂–æ–∫' %}</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".editable").forEach(cell => {
            cell.addEventListener("click", () => {
                if (cell.querySelector("textarea")) return;
                const value = cell.innerText.trim();
                const textarea = document.createElement("textarea");
                textarea.type = "text";
                textarea.classList.add("form-control", "form-control-sm");
                textarea.value = value === " " ? "" : value;
                textarea.style.width = "100%";
                textarea.style.height = "100%";
                textarea.style.boxSizing = "border-box";
                textarea.style.resize = "none";
                textarea.style.fontFamily = "inherit";
                textarea.style.fontSize = "inherit";
                textarea.style.padding = "5px";
                textarea.style.border = "1px solid #007bff";
                textarea.style.borderRadius = "2px";


                cell.innerHTML = "";
                cell.appendChild(textarea);
                textarea.focus();

                textarea.addEventListener("blur", () => {
                    const newValue = textarea.value;
                    const field = cell.dataset.field;
                    const id = cell.dataset.id;

                    fetch(`/arrangement/update/${id}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": getCookie("csrftoken"),
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ field, value: newValue })
                    }).then(() => {
                        cell.innerText = newValue || " ";
                    });
                });
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}